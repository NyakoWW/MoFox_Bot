# MCP Server-Sent Events (SSE) ä½¿ç”¨æŒ‡å—

## ğŸ“– æ¦‚è¿°

MCP SSE å®¢æˆ·ç«¯æ˜¯ MaiBot çš„ä¸€ä¸ªæ‰©å±•åŠŸèƒ½ï¼Œæä¾›ä¸ MCP (Model Context Protocol) æœåŠ¡å™¨çš„å®æ—¶äº‹ä»¶è®¢é˜…èƒ½åŠ›ã€‚é€šè¿‡ Server-Sent Events (SSE) æŠ€æœ¯ï¼ŒMaiBot å¯ä»¥æ¥æ”¶æ¥è‡ª MCP æœåŠ¡å™¨çš„å®æ—¶äº‹ä»¶æ¨é€ï¼Œå®ç°ä½å»¶è¿Ÿçš„äº¤äº’å“åº”ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- ğŸ”— **å®æ—¶è¿æ¥**: ä¸ MCP æœåŠ¡å™¨å»ºç«‹æŒä¹…çš„ SSE è¿æ¥
- ğŸ”„ **è‡ªåŠ¨é‡è¿**: æ”¯æŒæŒ‡æ•°é€€é¿ç­–ç•¥çš„æ–­çº¿é‡è¿æœºåˆ¶
- ğŸ¯ **äº‹ä»¶è®¢é˜…**: çµæ´»çš„äº‹ä»¶ç±»å‹è®¢é˜…å’Œå¤„ç†ç³»ç»Ÿ
- ğŸ” **å®‰å…¨è®¤è¯**: æ”¯æŒ Bearer Token å’Œ SSL/TLS è®¤è¯
- ğŸ“Š **ç›‘æ§ç»Ÿè®¡**: æä¾›è¿æ¥çŠ¶æ€å’Œäº‹ä»¶ç»Ÿè®¡ä¿¡æ¯
- ğŸ›¡ï¸ **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¬¬ä¸€æ­¥ï¼šå¯ç”¨ MCP SSE åŠŸèƒ½

1. æ‰“å¼€ `config/bot_config.toml` é…ç½®æ–‡ä»¶
2. æ‰¾åˆ° `[mcp_sse]` é…ç½®æ®µï¼Œå¦‚æœæ²¡æœ‰è¯·æ·»åŠ ï¼š

```toml
[mcp_sse]
enable = true  # å¯ç”¨ MCP SSE åŠŸèƒ½
server_url = "http://your-mcp-server.com:8080/events"  # MCP æœåŠ¡å™¨ SSE ç«¯ç‚¹
auth_key = "your-auth-token"  # è®¤è¯å¯†é’¥ï¼ˆå¯é€‰ï¼‰
```

### ç¬¬äºŒæ­¥ï¼šé…ç½®è¿æ¥å‚æ•°

```toml
[mcp_sse]
# åŸºæœ¬é…ç½®
enable = true
server_url = "http://localhost:8080/events"
auth_key = ""

# è¿æ¥é…ç½®
connection_timeout = 30  # è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
read_timeout = 60       # è¯»å–è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

# é‡è¿é…ç½®
enable_reconnect = true           # å¯ç”¨è‡ªåŠ¨é‡è¿
max_reconnect_attempts = 10       # æœ€å¤§é‡è¿æ¬¡æ•°ï¼ˆ-1 è¡¨ç¤ºæ— é™é‡è¿ï¼‰
initial_reconnect_delay = 1.0     # åˆå§‹é‡è¿å»¶è¿Ÿï¼ˆç§’ï¼‰
max_reconnect_delay = 60.0        # æœ€å¤§é‡è¿å»¶è¿Ÿï¼ˆç§’ï¼‰
reconnect_backoff_factor = 2.0    # é‡è¿å»¶è¿ŸæŒ‡æ•°é€€é¿å› å­

# äº‹ä»¶å¤„ç†é…ç½®
event_buffer_size = 1000          # äº‹ä»¶ç¼“å†²åŒºå¤§å°
enable_event_logging = true       # å¯ç”¨äº‹ä»¶æ—¥å¿—è®°å½•

# è®¢é˜…é…ç½®
subscribed_events = []            # è®¢é˜…çš„äº‹ä»¶ç±»å‹ï¼ˆç©ºåˆ—è¡¨è¡¨ç¤ºè®¢é˜…æ‰€æœ‰äº‹ä»¶ï¼‰
# ç¤ºä¾‹ï¼šåªè®¢é˜…ç‰¹å®šäº‹ä»¶
# subscribed_events = ["chat.message", "user.login", "system.status"]

# é«˜çº§é…ç½®
user_agent = "MaiBot-MCP-SSE-Client/1.0"  # ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²

# SSL é…ç½®
verify_ssl = true        # æ˜¯å¦éªŒè¯ SSL è¯ä¹¦
ssl_cert_path = ""       # SSL å®¢æˆ·ç«¯è¯ä¹¦è·¯å¾„ï¼ˆå¯é€‰ï¼‰
ssl_key_path = ""        # SSL å®¢æˆ·ç«¯å¯†é’¥è·¯å¾„ï¼ˆå¯é€‰ï¼‰
```

### ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨ MaiBot

æ­£å¸¸å¯åŠ¨ MaiBotï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆå§‹åŒ– MCP SSE å®¢æˆ·ç«¯ï¼š

```bash
python bot.py
```

å¯åŠ¨æ—¥å¿—ä¸­ä¼šæ˜¾ç¤º MCP SSE ç›¸å…³ä¿¡æ¯ï¼š

```
[INFO] åˆå§‹åŒ– MCP SSE ç®¡ç†å™¨
[INFO] è¿æ¥åˆ° MCP æœåŠ¡å™¨: http://localhost:8080/events
[INFO] æˆåŠŸè¿æ¥åˆ° MCP æœåŠ¡å™¨
[INFO] MCP SSE ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ
```

## ğŸ“ é…ç½®è¯¦è§£

### åŸºæœ¬é…ç½®

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `enable` | bool | false | æ˜¯å¦å¯ç”¨ MCP SSE åŠŸèƒ½ |
| `server_url` | string | "" | MCP æœåŠ¡å™¨ SSE ç«¯ç‚¹ URL |
| `auth_key` | string | "" | è®¤è¯å¯†é’¥ï¼Œç”¨äº Bearer Token è®¤è¯ |

### è¿æ¥é…ç½®

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `connection_timeout` | int | 30 | è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ |
| `read_timeout` | int | 60 | è¯»å–è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ |

### é‡è¿é…ç½®

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `enable_reconnect` | bool | true | æ˜¯å¦å¯ç”¨è‡ªåŠ¨é‡è¿ |
| `max_reconnect_attempts` | int | 10 | æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œ-1 è¡¨ç¤ºæ— é™é‡è¿ |
| `initial_reconnect_delay` | float | 1.0 | åˆå§‹é‡è¿å»¶è¿Ÿæ—¶é—´ï¼ˆç§’ï¼‰ |
| `max_reconnect_delay` | float | 60.0 | æœ€å¤§é‡è¿å»¶è¿Ÿæ—¶é—´ï¼ˆç§’ï¼‰ |
| `reconnect_backoff_factor` | float | 2.0 | é‡è¿å»¶è¿ŸæŒ‡æ•°é€€é¿å› å­ |

### äº‹ä»¶å¤„ç†é…ç½®

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `event_buffer_size` | int | 1000 | äº‹ä»¶ç¼“å†²åŒºå¤§å° |
| `enable_event_logging` | bool | true | æ˜¯å¦å¯ç”¨äº‹ä»¶æ—¥å¿—è®°å½• |
| `subscribed_events` | list | [] | è®¢é˜…çš„äº‹ä»¶ç±»å‹åˆ—è¡¨ |

## ğŸ¯ äº‹ä»¶ç±»å‹

MCP SSE æ”¯æŒå¤šç§äº‹ä»¶ç±»å‹ï¼Œå¸¸è§çš„åŒ…æ‹¬ï¼š

### ç³»ç»Ÿäº‹ä»¶
- `system.status` - ç³»ç»ŸçŠ¶æ€å˜åŒ–
- `system.heartbeat` - ç³»ç»Ÿå¿ƒè·³
- `system.shutdown` - ç³»ç»Ÿå…³é—­

### ç”¨æˆ·äº‹ä»¶
- `user.login` - ç”¨æˆ·ç™»å½•
- `user.logout` - ç”¨æˆ·ç™»å‡º
- `user.action` - ç”¨æˆ·è¡Œä¸º

### èŠå¤©äº‹ä»¶
- `chat.message` - èŠå¤©æ¶ˆæ¯
- `chat.typing` - æ­£åœ¨è¾“å…¥
- `chat.reaction` - æ¶ˆæ¯ååº”

### é€šçŸ¥äº‹ä»¶
- `notification.info` - ä¿¡æ¯é€šçŸ¥
- `notification.warning` - è­¦å‘Šé€šçŸ¥
- `notification.error` - é”™è¯¯é€šçŸ¥

## ğŸ”§ é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰äº‹ä»¶å¤„ç†å™¨

å¦‚æœæ‚¨éœ€è¦å¯¹ç‰¹å®šäº‹ä»¶è¿›è¡Œè‡ªå®šä¹‰å¤„ç†ï¼Œå¯ä»¥é€šè¿‡æ’ä»¶ç³»ç»Ÿæˆ–ç›´æ¥ä¿®æ”¹ä»£ç æ¥æ³¨å†Œäº‹ä»¶å¤„ç†å™¨ï¼š

```python
from src.mcp import get_mcp_sse_manager

# è·å– MCP SSE ç®¡ç†å™¨
manager = get_mcp_sse_manager()

if manager:
    # æ³¨å†ŒèŠå¤©æ¶ˆæ¯äº‹ä»¶å¤„ç†å™¨
    def handle_chat_message(event):
        print(f"æ”¶åˆ°èŠå¤©æ¶ˆæ¯: {event.data}")
        # åœ¨è¿™é‡Œæ·»åŠ æ‚¨çš„è‡ªå®šä¹‰é€»è¾‘
    
    manager.register_event_handler("chat.message", handle_chat_message)
    
    # æ³¨å†Œå…¨å±€äº‹ä»¶å¤„ç†å™¨
    def handle_all_events(event):
        print(f"æ”¶åˆ°äº‹ä»¶: {event.event_type} - {event.data}")
    
    manager.register_global_event_handler(handle_all_events)
```

### è·å–è¿æ¥çŠ¶æ€

```python
from src.mcp import get_mcp_sse_manager

manager = get_mcp_sse_manager()
if manager:
    # æ£€æŸ¥è¿æ¥çŠ¶æ€
    if manager.is_connected():
        print("MCP SSE å®¢æˆ·ç«¯å·²è¿æ¥")
    
    # è·å–è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
    stats = manager.get_stats()
    print(f"è¿æ¥çŠ¶æ€: {stats['connected']}")
    print(f"è¿è¡ŒçŠ¶æ€: {stats['running']}")
    print(f"æ€»æ¥æ”¶äº‹ä»¶æ•°: {stats['total_events_received']}")
    print(f"é‡è¿æ¬¡æ•°: {stats['reconnect_attempts']}")
```

### æŸ¥çœ‹æœ€è¿‘äº‹ä»¶

```python
from src.mcp import get_mcp_sse_manager

manager = get_mcp_sse_manager()
if manager:
    # è·å–æœ€è¿‘ 10 ä¸ªäº‹ä»¶
    recent_events = manager.get_recent_events(10)
    
    for event in recent_events:
        print(f"{event.timestamp}: {event.event_type}")
        print(f"æ•°æ®: {event.data}")
        print("---")
```

## ğŸ§ª æµ‹è¯•åŠŸèƒ½

é¡¹ç›®åŒ…å«äº†å®Œæ•´çš„æµ‹è¯•å·¥å…·ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥éªŒè¯ MCP SSE åŠŸèƒ½ï¼š

### åŸºæœ¬åŠŸèƒ½æµ‹è¯•

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/MaiBot

# è¿è¡ŒåŸºæœ¬åŠŸèƒ½æµ‹è¯•
python -m src.mcp.test_client
```

### é‡è¿åŠŸèƒ½æµ‹è¯•

```bash
# æµ‹è¯•æ–­çº¿é‡è¿åŠŸèƒ½
python -m src.mcp.test_client reconnect
```

æµ‹è¯•è„šæœ¬ä¼šè¾“å‡ºè¯¦ç»†çš„æµ‹è¯•ç»“æœï¼ŒåŒ…æ‹¬ï¼š
- è¿æ¥çŠ¶æ€
- æ¥æ”¶åˆ°çš„äº‹ä»¶æ•°é‡
- äº‹ä»¶ç±»å‹ç»Ÿè®¡
- è¿æ¥æ—¶é•¿å’Œæ€§èƒ½æŒ‡æ ‡

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. è¿æ¥å¤±è´¥

**é—®é¢˜**: æ— æ³•è¿æ¥åˆ° MCP æœåŠ¡å™¨

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ `server_url` é…ç½®æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ MCP æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ
- æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®
- éªŒè¯ç«¯å£æ˜¯å¦å¯è®¿é—®

#### 2. è®¤è¯å¤±è´¥

**é—®é¢˜**: æ”¶åˆ° 401 è®¤è¯é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ `auth_key` é…ç½®æ˜¯å¦æ­£ç¡®
- ç¡®è®¤è®¤è¯å¯†é’¥æ˜¯å¦æœ‰æ•ˆ
- è”ç³» MCP æœåŠ¡å™¨ç®¡ç†å‘˜è·å–æ­£ç¡®çš„è®¤è¯ä¿¡æ¯

#### 3. SSL è¯ä¹¦é”™è¯¯

**é—®é¢˜**: SSL è¯ä¹¦éªŒè¯å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥æœåŠ¡å™¨ SSL è¯ä¹¦æ˜¯å¦æœ‰æ•ˆ
- ä¸´æ—¶è®¾ç½® `verify_ssl = false` è¿›è¡Œæµ‹è¯•
- é…ç½®æ­£ç¡®çš„å®¢æˆ·ç«¯è¯ä¹¦è·¯å¾„

#### 4. é¢‘ç¹é‡è¿

**é—®é¢˜**: å®¢æˆ·ç«¯ä¸æ–­é‡è¿

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ç½‘ç»œè¿æ¥ç¨³å®šæ€§
- è°ƒæ•´é‡è¿å‚æ•°ï¼ˆå¢åŠ å»¶è¿Ÿæ—¶é—´ï¼‰
- æ£€æŸ¥æœåŠ¡å™¨ç«¯æ˜¯å¦æœ‰è¿æ¥é™åˆ¶

#### 5. äº‹ä»¶ä¸¢å¤±

**é—®é¢˜**: éƒ¨åˆ†äº‹ä»¶æ²¡æœ‰æ”¶åˆ°

**è§£å†³æ–¹æ¡ˆ**:
- å¢åŠ  `event_buffer_size` é…ç½®
- æ£€æŸ¥äº‹ä»¶å¤„ç†å™¨æ˜¯å¦æœ‰å¼‚å¸¸
- ç¡®è®¤ `subscribed_events` é…ç½®æ˜¯å¦æ­£ç¡®

### æ—¥å¿—è°ƒè¯•

MCP SSE ç›¸å…³æ—¥å¿—ä½¿ç”¨ä»¥ä¸‹æ ‡ç­¾ï¼š

- `mcp.sse_client` - SSE å®¢æˆ·ç«¯æ—¥å¿—
- `mcp.event_handler` - äº‹ä»¶å¤„ç†å™¨æ—¥å¿—  
- `mcp.manager` - ç®¡ç†å™¨æ—¥å¿—

æ‚¨å¯ä»¥é€šè¿‡è°ƒæ•´æ—¥å¿—çº§åˆ«æ¥è·å–æ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼š

```toml
[log]
console_log_level = "DEBUG"  # è®¾ç½®ä¸º DEBUG çº§åˆ«æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
```

## ğŸ“š API å‚è€ƒ

### MCPSSEManager

ä¸»è¦çš„ç®¡ç†å™¨ç±»ï¼Œæä¾›ä»¥ä¸‹æ–¹æ³•ï¼š

- `is_running()` - æ£€æŸ¥æ˜¯å¦æ­£åœ¨è¿è¡Œ
- `is_connected()` - æ£€æŸ¥æ˜¯å¦å·²è¿æ¥
- `get_stats()` - è·å–ç»Ÿè®¡ä¿¡æ¯
- `get_recent_events(count)` - è·å–æœ€è¿‘çš„äº‹ä»¶
- `register_event_handler(event_type, handler)` - æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
- `register_global_event_handler(handler)` - æ³¨å†Œå…¨å±€äº‹ä»¶å¤„ç†å™¨

### MCPEvent

äº‹ä»¶å¯¹è±¡ï¼ŒåŒ…å«ä»¥ä¸‹å±æ€§ï¼š

- `event_type` - äº‹ä»¶ç±»å‹
- `data` - äº‹ä»¶æ•°æ®ï¼ˆå­—å…¸æ ¼å¼ï¼‰
- `timestamp` - äº‹ä»¶æ—¶é—´æˆ³
- `event_id` - äº‹ä»¶ IDï¼ˆå¯é€‰ï¼‰
- `retry` - é‡è¯•é—´éš”ï¼ˆå¯é€‰ï¼‰

## ğŸ¤ è´¡çŒ®

å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼Œæ¬¢è¿ï¼š

1. æäº¤ Issue æŠ¥å‘Šé—®é¢˜
2. æäº¤ Pull Request è´¡çŒ®ä»£ç 
3. å®Œå–„æ–‡æ¡£å’Œç¤ºä¾‹

## ğŸ“„ è®¸å¯è¯

æœ¬åŠŸèƒ½éµå¾ª MaiBot é¡¹ç›®çš„è®¸å¯è¯åè®®ã€‚