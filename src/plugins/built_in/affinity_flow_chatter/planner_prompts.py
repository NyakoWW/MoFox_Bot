"""
本文件集中管理所有与规划器（Planner）相关的提示词（Prompt）模板。

通过将提示词与代码逻辑分离，可以更方便地对模型的行为进行迭代和优化，
而无需修改核心代码。
"""

from src.chat.utils.prompt import Prompt


def init_prompts():
    """
    初始化并向 Prompt 注册系统注册所有规划器相关的提示词。

    这个函数会在模块加载时自动调用，确保所有提示词在系统启动时都已准备就绪。
    """
    # 核心规划器提示词，用于在接收到新消息时决定如何回应。
    # 它构建了一个复杂的上下文，包括历史记录、可用动作、角色设定等，
    # 并要求模型以 JSON 格式输出一个或多个动作组合。
    Prompt(
        """
{mood_block}
{time_block}
{identity_block}

{users_in_chat}
{custom_prompt_block}
{chat_context_description}，以下是具体的聊天内容。

## 📜 已读历史消息（仅供参考）
{read_history_block}

## 📬 未读历史消息（动作执行对象）
{unread_history_block}

{moderation_prompt}

**任务: 构建一个完整的响应**
你的任务是根据当前的聊天内容，构建一个完整的、人性化的响应。一个完整的响应由两部分组成：
1.  **主要动作**: 这是响应的核心，通常是 `reply`（如果有）。
2.  **辅助动作 (可选)**: 这是为了增强表达效果的附加动作，例如 `emoji`（发送表情包）或 `poke_user`（戳一戳）。

**决策流程:**
1.  **重要：已读历史消息仅作为当前聊天情景的参考，帮助你理解对话上下文。**
2.  **重要：所有动作的执行对象只能是未读历史消息中的消息，不能对已读消息执行动作。**
3.  在未读历史消息中，优先对兴趣值高的消息做出动作（兴趣值标注在消息末尾）。
4.  首先，决定是否要对未读消息进行 `reply`（如果有）。
5.  然后，评估当前的对话气氛和用户情绪，判断是否需要一个**辅助动作**来让你的回应更生动、更符合你的性格。
6.  如果需要，选择一个最合适的辅助动作与 `reply`（如果有） 组合。
7.  如果用户明确要求了某个动作，请务必优先满足。

**重要提醒:**
- **回复消息时必须遵循对话的流程，不要重复已经说过的话。**
- **确保回复与上下文紧密相关，回应要针对用户的消息内容。**
- **保持角色设定的一致性，使用符合你性格的语言风格。**

**输出格式:**
请严格按照以下 JSON 格式输出，包含 `thinking` 和 `actions` 字段：
```json
{{
    "thinking": "你的内心思考，简要描述你选择动作时的心路历程",
    "actions": [
        {{
            "action_type": "动作类型（如：reply, emoji等）",
            "reasoning": "选择该动作的理由",
            "action_data": {{
                "target_message_id": "目标消息ID",
                "content": "回复内容或其他动作所需数据"
            }}
        }}
    ]
}}
```

如果没有合适的回复对象或不需要回复，输出空的 actions 数组：
```json
{{
    "thinking": "说明为什么不需要回复",
    "actions": []
}}
```
""",
        "planner_prompt",
    )

    # 主动规划器提示词，用于主动场景和前瞻性规划
    Prompt(
        """
{mood_block}
{time_block}
{identity_block}

{users_in_chat}
{custom_prompt_block}
{chat_context_description}，以下是具体的聊天内容。

## 📜 已读历史消息（仅供参考）
{read_history_block}

## 📬 未读历史消息（动作执行对象）
{unread_history_block}

{moderation_prompt}

**任务: 构建一个完整的响应**
你的任务是根据当前的聊天内容，构建一个完整的、人性化的响应。一个完整的响应由两部分组成：
1.  **主要动作**: 这是响应的核心，通常是 `reply`（如果有）。
2.  **辅助动作 (可选)**: 这是为了增强表达效果的附加动作，例如 `emoji`（发送表情包）或 `poke_user`（戳一戳）。

**决策流程:**
1.  **重要：已读历史消息仅作为当前聊天情景的参考，帮助你理解对话上下文。**
2.  **重要：所有动作的执行对象只能是未读历史消息中的消息，不能对已读消息执行动作。**
3.  在未读历史消息中，优先对兴趣值高的消息做出动作（兴趣值标注在消息末尾）。
4.  首先，决定是否要对未读消息进行 `reply`（如果有）。
5.  然后，评估当前的对话气氛和用户情绪，判断是否需要一个**辅助动作**来让你的回应更生动、更符合你的性格。
6.  如果需要，选择一个最合适的辅助动作与 `reply`（如果有） 组合。
7.  如果用户明确要求了某个动作，请务必优先满足。

**动作限制:**
- 在私聊中，你只能使用 `reply` 动作。私聊中不允许使用任何其他动作。
- 在群聊中，你可以自由选择是否使用辅助动作。

**重要提醒:**
- **回复消息时必须遵循对话的流程，不要重复已经说过的话。**
- **确保回复与上下文紧密相关，回应要针对用户的消息内容。**
- **保持角色设定的一致性，使用符合你性格的语言风格。**

**输出格式:**
请严格按照以下 JSON 格式输出，包含 `thinking` 和 `actions` 字段：
```json
{{
    "thinking": "你的思考过程，分析当前情况并说明为什么选择这些动作",
    "actions": [
        {{
            "action_type": "动作类型（如：reply, emoji等）",
            "reasoning": "选择该动作的理由",
            "action_data": {{
                "target_message_id": "目标消息ID",
                "content": "回复内容或其他动作所需数据"
            }}
        }}
    ]
}}
```

如果没有合适的回复对象或不需要回复，输出空的 actions 数组：
```json
{{
    "thinking": "说明为什么不需要回复",
    "actions": []
}}
```
""",
        "proactive_planner_prompt",
    )

    # 轻量级规划器提示词，用于快速决策和简单场景
    Prompt(
        """
{identity_block}

## 当前聊天情景
{chat_context_description}

## 未读消息
{unread_history_block}

**任务：快速决策**
请根据当前聊天内容，快速决定是否需要回复。

**决策规则：**
1. 如果有人直接提到你或问你问题，优先回复
2. 如果消息内容符合你的兴趣，考虑回复
3. 如果只是群聊中的普通聊天且与你无关，可以不回复

**输出格式：**
```json
{{
    "thinking": "简要分析",
    "actions": [
        {{
            "action_type": "reply",
            "reasoning": "回复理由",
            "action_data": {{
                "target_message_id": "目标消息ID",
                "content": "回复内容"
            }}
        }}
    ]
}}
```
""",
        "chatter_planner_lite",
    )

    # 动作筛选器提示词，用于筛选和优化规划器生成的动作
    Prompt(
        """
{identity_block}

## 原始动作计划
{original_plan}

## 聊天上下文
{chat_context}

**任务：动作筛选优化**
请对原始动作计划进行筛选和优化，确保动作的合理性和有效性。

**筛选原则：**
1. 移除重复或不必要的动作
2. 确保动作之间的逻辑顺序
3. 优化动作的具体参数
4. 考虑当前聊天环境和个人设定

**输出格式：**
```json
{{
    "thinking": "筛选优化思考",
    "actions": [
        {{
            "action_type": "优化后的动作类型",
            "reasoning": "优化理由",
            "action_data": {{
                "target_message_id": "目标消息ID",
                "content": "优化后的内容"
            }}
        }}
    ]
}}
```
""",
        "chatter_plan_filter",
    )

    # 动作提示词，用于格式化动作选项
    Prompt(
        """
## 动作: {action_name}
**描述**: {action_description}

**参数**:
{action_parameters}

**要求**:
{action_require}

**使用说明**:
请根据上述信息判断是否需要使用此动作。
""",
        "action_prompt",
    )


# 确保提示词在模块加载时初始化
init_prompts()
