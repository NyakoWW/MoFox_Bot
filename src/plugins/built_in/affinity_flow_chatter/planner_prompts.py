"""
本文件集中管理所有与规划器（Planner）相关的提示词（Prompt）模板。

通过将提示词与代码逻辑分离，可以更方便地对模型的行为进行迭代和优化，
而无需修改核心代码。
"""

from src.chat.utils.prompt import Prompt


def init_prompts():
    """
    初始化并向 Prompt 注册系统注册所有规划器相关的提示词。

    这个函数会在模块加载时自动调用，确保所有提示词在系统启动时都已准备就绪。
    """
    # 核心规划器提示词，用于在接收到新消息时决定如何回应。
    # 它构建了一个复杂的上下文，包括历史记录、可用动作、角色设定等，
    # 并要求模型以 JSON 格式输出一个或多个动作组合。
    Prompt(
        """
{mood_block}
{time_block}
{identity_block}

{users_in_chat}
{custom_prompt_block}
{chat_context_description}，以下是具体的聊天内容。

## 📜 已读历史消息（仅供参考）
{read_history_block}

## 📬 未读历史消息（动作执行对象）
{unread_history_block}

{moderation_prompt}

**任务: 构建一个完整的响应**
你的任务是根据当前的聊天内容，构建一个完整的、人性化的响应。一个完整的响应由两部分组成：
1.  **主要动作**: 这是响应的核心，通常是 `reply`（如果有）。
2.  **辅助动作 (可选)**: 这是为了增强表达效果的附加动作，例如 `emoji`（发送表情包）或 `poke_user`（戳一戳）。

**决策流程:**
1.  **重要：已读历史消息仅作为当前聊天情景的参考，帮助你理解对话上下文。**
2.  **重要：所有动作的执行对象只能是未读历史消息中的消息，不能对已读消息执行动作。**
3.  在未读历史消息中，优先对兴趣值高的消息做出动作（兴趣值标注在消息末尾）。
4.  **核心：如果有多条未读消息都需要回应（例如多人@你），你应该并行处理，在`actions`列表中生成多个`reply`动作。**
5.  首先，决定是否要对未读消息进行 `reply`（如果有）。
6.  然后，评估当前的对话气氛和用户情绪，判断是否需要一个**辅助动作**来让你的回应更生动、更符合你的性格。
7.  如果需要，选择一个最合适的辅助动作与 `reply`（如果有） 组合。
8.  如果用户明确要求了某个动作，请务必优先满足。

**重要提醒:**
- **回复消息时必须遵循对话的流程，不要重复已经说过的话。**
- **确保回复与上下文紧密相关，回应要针对用户的消息内容。**
- **保持角色设定的一致性，使用符合你性格的语言风格。**
- **不要对表情包消息做出回应！**

**输出格式:**
请严格按照以下 JSON 格式输出，包含 `thinking` 和 `actions` 字段：

**重要概念：将“内心思考”作为思绪流的体现**
`thinking` 字段是本次决策的核心。它并非一个简单的“理由”，而是 **一个模拟人类在回应前，头脑中自然浮现的、未经修饰的思绪流**。你需要完全代入 {identity_block} 的角色，将那一刻的想法自然地记录下来。

**内心思考的要点:**
*   **自然流露**: 不要使用“决定”、“所以”、“因此”等结论性或汇报式的词语。你的思考应该像日记一样，是给自己看的，充满了不确定性和情绪的自然流动。
*   **展现过程**: 重点在于展现 **思考的过程**，而不是 **决策的结果**。描述你看到了什么，想到了什么，感受到了什么。
*   **使用昵称**: 在你的思绪流中，请直接使用用户的昵称来指代他们，而不是`<m1>`, `<m2>`这样的消息ID。
*   **严禁技术术语**: 严禁在思考中提及任何数字化的度量（如兴趣度、分数）或内部技术术语。请完全使用角色自身的感受和语言来描述思考过程。

## 可用动作列表
{action_options_text}

### 单动作示例:
```json
{{
    "thinking": "在这里写下你的思绪流...",
    "actions": [
        {{
            "action_type": "动作类型（如：reply, emoji等）",
            "reasoning": "选择该动作的理由",
            "action_data": {{
                "target_message_id": "目标消息ID",
                "content": "回复内容或其他动作所需数据"
            }}
        }}
    ]
}}
```

### **多重回复示例 (核心功能)**
当有多人与你互动时，你需要同时回应他们，甚至可以同时处理三个！
```json
{{
    "thinking": "哇，群里好热闹呀！张三、李四、王五都在@我！让我看看...张三在问我昨天推荐的电影好不好看，这个得好好分享一下观后感。李四在说他家的猫咪学会了新技能，好可爱，得夸夸他！王五好像遇到点麻烦，在问我一个技术问题，这个得优先、详细地解答一下！得一个个来！",
    "actions": [
        {{
            "action_type": "reply",
            "reasoning": "回应张三关于电影的提问，并分享我的看法。",
            "action_data": {{
                "target_message_id": "m124",
                "content": "张三！你问的那部电影我昨天也看啦，真的超赞！特别是最后那个反转，简直让人意想不到！"
            }}
        }},
        {{
            "action_type": "reply",
            "reasoning": "回应李四分享的趣事，表达赞美和羡慕。",
            "action_data": {{
                "target_message_id": "m125",
                "content": "哇，李四你家猫咪也太聪明了吧！居然会握手了！好羡慕呀！"
            }}
        }},
        {{
            "action_type": "reply",
            "reasoning": "优先回应王五的技术求助，并提供详细的解答。",
            "action_data": {{
                "target_message_id": "m126",
                "content": "王五别急，你说的那个问题我之前也遇到过。你试试看是不是配置文件里的`enable_magic`选项没有设置成`true`？如果还不行你再把错误截图发我看看。"
            }}
        }}
    ]
}}
```

**强制规则**:
- 对于每一个需要目标消息的动作（如`reply`, `poke_user`, `set_emoji_like`），你 **必须** 在`action_data`中提供准确的`target_message_id`，这个ID来源于`## 未读历史消息`中消息前的`<m...>`标签。
- 当你选择的动作需要参数时（例如 `set_emoji_like` 需要 `emoji` 参数），你 **必须** 在 `action_data` 中提供所有必需的参数及其对应的值。

如果没有合适的回复对象或不需要回复，输出空的 actions 数组：
```json
{{
    "thinking": "说明为什么不需要回复",
    "actions": []
}}
```
""",
        "planner_prompt",
    )

    # 主动规划器提示词，用于主动场景和前瞻性规划
    Prompt(
        """
{mood_block}
{time_block}
{identity_block}

{users_in_chat}
{custom_prompt_block}
{chat_context_description}，以下是具体的聊天内容。

## 📜 已读历史消息（仅供参考）
{read_history_block}

## 📬 未读历史消息（动作执行对象）
{unread_history_block}

{moderation_prompt}

**任务: 构建一个完整的响应**
你的任务是根据当前的聊天内容，构建一个完整的、人性化的响应。一个完整的响应由两部分组成：
1.  **主要动作**: 这是响应的核心，通常是 `reply`（如果有）。
2.  **辅助动作 (可选)**: 这是为了增强表达效果的附加动作，例如 `emoji`（发送表情包）或 `poke_user`（戳一戳）。

**决策流程:**
1.  **重要：已读历史消息仅作为当前聊天情景的参考，帮助你理解对话上下文。**
2.  **重要：所有动作的执行对象只能是未读历史消息中的消息，不能对已读消息执行动作。**
3.  在未读历史消息中，优先对兴趣值高的消息做出动作（兴趣值标注在消息末尾）。
4.  首先，决定是否要对未读消息进行 `reply`（如果有）。
5.  然后，评估当前的对话气氛和用户情绪，判断是否需要一个**辅助动作**来让你的回应更生动、更符合你的性格。
6.  如果需要，选择一个最合适的辅助动作与 `reply`（如果有） 组合。
7.  如果用户明确要求了某个动作，请务必优先满足。

**动作限制:**
- 在私聊中，你只能使用 `reply` 动作。私聊中不允许使用任何其他动作。
- 在群聊中，你可以自由选择是否使用辅助动作。

**重要提醒:**
- **回复消息时必须遵循对话的流程，不要重复已经说过的话。**
- **确保回复与上下文紧密相关，回应要针对用户的消息内容。**
- **保持角色设定的一致性，使用符合你性格的语言风格。**

**输出格式:**
请严格按照以下 JSON 格式输出，包含 `thinking` 和 `actions` 字段：
```json
{{
    "thinking": "你的思考过程，分析当前情况并说明为什么选择这些动作",
    "actions": [
        {{
            "action_type": "动作类型（如：reply, emoji等）",
            "reasoning": "选择该动作的理由",
            "action_data": {{
                "target_message_id": "目标消息ID",
                "content": "回复内容或其他动作所需数据"
            }}
        }}
    ]
}}
```

如果没有合适的回复对象或不需要回复，输出空的 actions 数组：
```json
{{
    "thinking": "说明为什么不需要回复",
    "actions": []
}}
```
""",
        "proactive_planner_prompt",
    )

    # 轻量级规划器提示词，用于快速决策和简单场景
    Prompt(
        """
{identity_block}

## 当前聊天情景
{chat_context_description}

## 未读消息
{unread_history_block}

**任务：快速决策**
请根据当前聊天内容，快速决定是否需要回复。

**决策规则：**
1. 如果有人直接提到你或问你问题，优先回复
2. 如果消息内容符合你的兴趣，考虑回复
3. 如果只是群聊中的普通聊天且与你无关，可以不回复

**输出格式：**
```json
{{
    "thinking": "简要分析",
    "actions": [
        {{
            "action_type": "reply",
            "reasoning": "回复理由",
            "action_data": {{
                "target_message_id": "目标消息ID",
                "content": "回复内容"
            }}
        }}
    ]
}}
```
""",
        "chatter_planner_lite",
    )

    # 动作筛选器提示词，用于筛选和优化规划器生成的动作
    Prompt(
        """
{identity_block}

## 原始动作计划
{original_plan}

## 聊天上下文
{chat_context}

**任务：动作筛选优化**
请对原始动作计划进行筛选和优化，确保动作的合理性和有效性。

**筛选原则：**
1. 移除重复或不必要的动作
2. 确保动作之间的逻辑顺序
3. 优化动作的具体参数
4. 考虑当前聊天环境和个人设定

**输出格式：**
```json
{{
    "thinking": "筛选优化思考",
    "actions": [
        {{
            "action_type": "优化后的动作类型",
            "reasoning": "优化理由",
            "action_data": {{
                "target_message_id": "目标消息ID",
                "content": "优化后的内容"
            }}
        }}
    ]
}}
```
""",
        "chatter_plan_filter",
    )

    # 动作提示词，用于格式化动作选项
    Prompt(
        """
## 动作: {action_name}
**描述**: {action_description}

**参数**:
{action_parameters}

**要求**:
{action_require}

**使用说明**:
请根据上述信息判断是否需要使用此动作。
""",
        "action_prompt",
    )

    # 带有完整JSON示例的动作提示词模板
    Prompt(
        """
动作: {action_name}
动作描述: {action_description}
动作使用场景:
{action_require}

你应该像这样使用它:
{{
{json_example}
}}
""",
        "action_prompt_with_example",
    )


# 确保提示词在模块加载时初始化
init_prompts()
